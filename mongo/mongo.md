文档
ObjectId
复合主键：主键是一个文档

直接匹配
比较操作符
逻辑操作符
字段操作符：$exist, $type
数组操作符：$all, $eleMatch
运算操作符：正则表达式

文档游标：
1. skip在limit之前执行；
2. sort在skip和limit之前执行；

文档投影: 除文档主键外，不可以在投影中混合使用包含与不包含；
数组投影: $slice, $eleMatch, $

更新文档
文档主键_id不可更改；
update整篇文档，只有第一篇符合query筛选条件的文档会被更新；

更新操作符：$set, $unset, $rename, $inc, $mul, $min, $max

数组更新操作符：$addToSet, $pop, $pull, $push

mongo只能保证单个文档操作的原子性，不能保证多个文档操作的原子性

### 聚合操作,aggregate
聚合管道，聚合表达式，聚合阶段，聚合操作符

#### 聚合表达式
字段路径表达式：$, .
系统变量表达式：$$
常量表达式：$literal

#### 聚合管道阶段：
$project, $match, $limit, $skip, $unwind, $sort, $lookup, $group, $out

### 索引，Index

#### 单键索引

#### 复合键索引
只支持前缀子查询；
索引之前考虑查询；

#### 多键索引
数组

#### 查询分析
explain()
仅返回索引的字段，能提高性能
索引会影响排序

唯一性，稀疏性，生存时间

### 数据模型

#### 内嵌式结构

文档关系：
1. 一次查询返回所有数据；
2. 更具独立性的数据应作为顶层文档；
3. 补充性数据应作为内嵌文档；

更新内嵌文档的复杂度增高；
适合读取频率远高于更新频率的数据；

#### 规范式结构

减少重复数据；
降低文档更新的复杂度；

需要多次读取操作才能得到完整的数据；
数组元素较多时，避免使用内嵌文档；

文档关系：
一对一：内嵌式结构；
一对多：内嵌式结构/规范式结构；
树形结构：parent，children，ancestors，左右编号；

### 复制集
高可用性

主节点：写，读(默认,可以从副节点读取)；
副节点：主节点数据备份；

复制集节点
每个节点都会向其他节点发送心跳请求；
每隔2秒发送一次，超过10秒则请求超时(默认)； 
复制集中最多可以有50个节点；

复制集选举
超过半数选票；
最多可以有7个投票节点；

触发：
主节点与副节点之间的心跳请求超时；
复制集初始化；
新节点加入复制集；

投票机：
没有数据；
可以投票；
不能成为主节点；

初始化：数据库，集合，索引，文档；
写库记录：增量同步；写库记录幂等；多线程分批次使用日志记录(_id)；
写库日志的大小和文档大小不一定成正比；
写库记录，单文档，会解析数据库操作成单文档操作；

### 数据库分片
可扩展性

纵向扩展
增强单一服务器性能

横向扩展
增加服务器数量

分片：每个分片存储一部分数据，可以部署为复制集；
主分片：存储所有不需要分片的集合；
mongos：可以将客户请求发送至相关的分片；
配置服务器：保存集群配置和元数据，可以部署为复制集；
分片片键：必须对应一个索引或索引前缀；（区间或hash）

1. 片键值的范围更广(可使用复合片键扩大范围);
2. 片键的分布更平衡(可使用复合片键平衡分布);
3. 片键值不要单向增大/减小(可使用哈希片键);














